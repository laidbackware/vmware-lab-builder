---
# SOFTWARE_DIR must contain all required software
vc_iso: "{{ lookup('env', 'SOFTWARE_DIR') }}/VMware-VCSA-all-8.0.3-24022515.iso"
esxi_ova: "{{ lookup('env', 'SOFTWARE_DIR') }}/Nested_ESXi8.0u3b_Appliance_Template_v1.ova"
vsan_witness_ova: "{{ lookup('env', 'SOFTWARE_DIR') }}/VMware-vSAN-ESA-Witness-8.0U3-24022510.ova"

environment_tag: "vsan-stretched"  # Used to prepend object names in hosting vCenter
dns_server: "192.168.0.1"
dns_domain: "home.local"
ntp_server_ip: "192.168.0.1"  # Must be set to an IP address!
disk_mode: thin  # How all disks should be deployed
nested_host_password: "{{ opinionated.master_password }}"

hosting_vcenter:  # This is the vCenter which will be the target for nested vCenters and ESXi hosts
  ip: "vcsa.lab"
  username: "{{ lookup('env', 'PARENT_VCENTER_USERNAME') }}"
  password: "{{ lookup('env', 'PARENT_VCENTER_PASSWORD') }}"
  datacenter: "Home"  # Target for all VM deployment

# This section is only referenced by other variables in this file
opinionated:
  master_password: "VMware1!"
  nested_hosts:
    cpu_cores: 12  # CPU count per nested host
    ram_in_gb: 100  # memory per nested host
    local_disks:  # (optional) this section can be removed to not modify local disks
      - size_gb: 500
  hosting_cluster: Physical
  hosting_datastore: NVME
  hosting_network:
    base:
      port_group: Nest
      cidr: "192.168.0.0/22"
      gateway: "192.168.0.1"
      starting_addr: "192.168.1.100"
    vsan:
      port_group: vsan-private
      vlan_id: 0
      cidr: 100.71.0.0/24


#####################################################################
### No need to edit below this line for an opinionated deployment ###
#####################################################################

nested_vcenter:  # the vCenter appliance that will be deployed
  ip: "{{ opinionated.hosting_network.base.starting_addr }}"  # vCenter ip address
  mask: "{{ opinionated.hosting_network.base.cidr.split('/')[1] }}"
  gw: "{{ opinionated.hosting_network.base.gateway }}"
  host_name: "{{ opinionated.hosting_network.base.starting_addr }}"  # FQDN if there is working DNS server, otherwise put the ip as a name
  username: "administrator@vsphere.local"
  password: "{{ opinionated.master_password }}"
  datacenter: "Lab"  # DC to create after deployment
  # Below are properties of parent cluster
  hosting_network: "{{ opinionated.hosting_network.base.port_group }}"  # Parent port group where the vCenter VM will be deployed
  hosting_cluster: "{{ opinionated.hosting_cluster }}"  # Parent cluster where the vCenter VM will be deployed
  hosting_datastore: "{{ opinionated.hosting_datastore }}"  # Parent datastore where the vCenter VM will be deployed

nested_clusters:  # You can add clusters in this section by duplicating the existing cluster
  compute:  # This will be the name of the cluster in the nested  vCenter. Below are the minimum settings.
    enable_drs: true
    # Below are properties of the hosting cluster
    hosting_cluster: "{{ opinionated.hosting_cluster }}"  # The nested ESXi VMs will be deployed here
    hosting_datastore: "{{ opinionated.hosting_datastore }}"  # Datastore target for nested ESXi VMs
    # Settings below are assigned to each host in the cluster
    vswitch0_vm_port_group_name: vm-network
    vswitch0_vm_port_group_vlan: "0"
    cpu_cores: "{{ opinionated.nested_hosts.cpu_cores }}"  # CPU count
    ram_in_gb: "{{ opinionated.nested_hosts.ram_in_gb }}"  # memory
    # In order list of disks to assign to the nested host. All will be marked as SSD.
    # Datastore names will be automatically be pre-pended with the hostname. E.g esx1
    # If the datastore_prefix property is removed the disk will not be set as a datastore
    # To leave the default OVA disks in place, delete this section.
    nested_hosts_disks: "{{ opinionated.nested_hosts.local_disks | default(omit) }}"
    # Added in vmnic order, these port groups must exist on the physical host
    # Must specify at least 2 port groups, up to a maximum of 10
    vmnic_physical_portgroup_assignment:
      - name: "{{ opinionated.hosting_network.base.port_group }}"
      - name: "{{ opinionated.hosting_network.vsan.port_group }}"

# opinionated_host_ip_ofset: 1
# # See the custom example for host to build hosts out manually
nested_hosts:
  - name: esx1
    ip: "{{ opinionated.hosting_network.base.starting_addr | ansible.utils.ipmath(1) }}"
    mask: "{{ opinionated.hosting_network.base.cidr | ansible.utils.ipaddr('netmask') }}"
    gw: "{{ opinionated.hosting_network.base.gateway }}"
    nested_cluster: "compute"
  - name: esx2
    ip: "{{ opinionated.hosting_network.base.starting_addr | ansible.utils.ipmath(2) }}"
    mask: "{{ opinionated.hosting_network.base.cidr | ansible.utils.ipaddr('netmask') }}"
    gw: "{{ opinionated.hosting_network.base.gateway }}"
    nested_cluster: "compute"
  - name: esx3
    ip: "{{ opinionated.hosting_network.base.starting_addr | ansible.utils.ipmath(3) }}"
    mask: "{{ opinionated.hosting_network.base.cidr | ansible.utils.ipaddr('netmask') }}"
    gw: "{{ opinionated.hosting_network.base.gateway }}"
    nested_cluster: "compute"
  - name: esx4
    ip: "{{ opinionated.hosting_network.base.starting_addr | ansible.utils.ipmath(4) }}"
    mask: "{{ opinionated.hosting_network.base.cidr | ansible.utils.ipaddr('netmask') }}"
    gw: "{{ opinionated.hosting_network.base.gateway }}"
    nested_cluster: "compute"

distributed_switches:
  - vds_name: vsan-vds
    mtu: 9000
    vds_version: 8.0.3
    clusters:  # distributed switch will be attached to all hosts in the clusters listed
      - compute
    uplink_quantity: 1
    vmnics:
      - vmnic1
    distributed_port_groups:
      - port_group_name: vsan
        vlan_id: 0


vsan:
  witness:
    vm_name:
    ip: "{{ opinionated.hosting_network.base.starting_addr | ansible.utils.ipmath(5) }}"
    mask: "{{ opinionated.hosting_network.base.cidr | ansible.utils.ipaddr('netmask') }}"
    gw: "{{ opinionated.hosting_network.base.gateway }}"
    root_password: "{{ opinionated.master_password }}{{ opinionated.master_password }}"
    vcenter_ip: "{{ hosting_vcenter.ip }}"
    vcenter_username: "{{ hosting_vcenter.username }}"
    vcenter_password: "{{ hosting_vcenter.password }}"
    vcenter_datacenter: "{{ hosting_vcenter.datacenter }}"
    vcenter_datastore: "{{ opinionated.hosting_datastore }}"
    vcenter_cluster: "{{ opinionated.hosting_cluster }}"
    vcenter_network: "{{ opinionated.hosting_network.base.port_group }}"
  host_vmks:
    - host: "{{ opinionated.hosting_network.base.starting_addr | ansible.utils.ipmath(1) }}"
      ip: "{{ opinionated.hosting_network.vsan.cidr | ansible.utils.ipaddr('2') | ansible.utils.ipv4('address') }}"
      netmask: "{{ opinionated.hosting_network.vsan.cidr | ansible.utils.ipaddr('netmask') }}"
      dvs: vsan-vds
      port_group: vsan
      enable_mgmt: false
      enable_vsan: true
    - host: "{{ opinionated.hosting_network.base.starting_addr | ansible.utils.ipmath(2) }}"
      ip: "{{ opinionated.hosting_network.vsan.cidr | ansible.utils.ipaddr('3') | ansible.utils.ipv4('address') }}"
      netmask: "{{ opinionated.hosting_network.vsan.cidr | ansible.utils.ipaddr('netmask') }}"
      dvs: vsan-vds
      port_group: vsan
      enable_mgmt: false
      enable_vsan: true
    - host: "{{ opinionated.hosting_network.base.starting_addr | ansible.utils.ipmath(3) }}"
      ip: "{{ opinionated.hosting_network.vsan.cidr | ansible.utils.ipaddr('4') | ansible.utils.ipv4('address') }}"
      netmask: "{{ opinionated.hosting_network.vsan.cidr | ansible.utils.ipaddr('netmask') }}"
      dvs: vsan-vds
      port_group: vsan
      enable_mgmt: false
      enable_vsan: true
    - host: "{{ opinionated.hosting_network.base.starting_addr | ansible.utils.ipmath(4) }}"
      ip: "{{ opinionated.hosting_network.vsan.cidr | ansible.utils.ipaddr('5') | ansible.utils.ipv4('address') }}"
      netmask: "{{ opinionated.hosting_network.vsan.cidr | ansible.utils.ipaddr('netmask') }}"
      dvs: vsan-vds
      port_group: vsan
      enable_mgmt: false
      enable_vsan: true

